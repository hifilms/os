<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Settings Pro - Gemini OS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #38bdf8;
            --bg: #0f172a;
            --sidebar-bg: rgba(15, 23, 42, 0.95);
            --card-bg: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text-main); margin: 0; overflow: hidden; height: 100vh; }
        
        .container { display: flex; height: 100%; }

        /* Sidebar */
        .sidebar { width: 240px; background: var(--sidebar-bg); border-right: 1px solid var(--border); padding: 25px 15px; }
        .sidebar h2 { font-size: 1.2rem; color: var(--primary); margin-bottom: 30px; padding-left: 10px; }
        .nav-link { 
            display: flex; align-items: center; gap: 12px; padding: 12px; 
            border-radius: 12px; cursor: pointer; color: var(--text-dim); 
            transition: 0.3s; margin-bottom: 8px; 
        }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-link.active { background: var(--primary); color: #000; font-weight: bold; }

        /* Content Area */
        .content { flex: 1; padding: 40px; overflow-y: auto; scrollbar-width: none; }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* General Card */
        .card { background: var(--card-bg); border: 1px solid var(--border); padding: 25px; border-radius: 20px; margin-bottom: 25px; }

        /* About & Inline Edit */
        .profile-header { text-align: center; }
        .avatar-icon { font-size: 4rem; color: var(--primary); margin-bottom: 10px; }
        .inline-edit { display: none; margin-top: 15px; }
        .inline-edit input { width: 250px; padding: 10px; border-radius: 8px; border: 1px solid var(--primary); background: #1e293b; color: white; text-align: center; }
        .storage-label { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; }
        .progress-bar { width: 100%; height: 10px; background: #1e293b; border-radius: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 1s ease; }

        /* Wallpaper with Preview */
        .live-preview-box { 
            width: 100%; height: 160px; border-radius: 15px; margin-bottom: 20px;
            background-size: cover; background-position: center; border: 2px solid var(--primary);
            display: flex; align-items: flex-end; padding: 15px; 
        }
        .preview-tag { background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 5px; font-size: 0.7rem; color: var(--primary); }
        .wp-container { display: flex; gap: 12px; overflow-x: auto; padding: 5px 0; scrollbar-width: thin; }
        .wp-item { min-width: 140px; height: 80px; border-radius: 10px; cursor: pointer; background-size: cover; transition: 0.3s; flex-shrink: 0; border: 2px solid transparent; }
        .wp-item:hover { transform: scale(1.05); border-color: var(--primary); }

        /* Security with Spacing */
        .input-wrapper { position: relative; margin-bottom: 15px; }
        .input-wrapper i { position: absolute; right: 15px; top: 14px; cursor: pointer; color: var(--text-dim); }
        input[type="password"], input[type="text"] { 
            width: 100%; background: #1e293b; border: 1px solid var(--border); 
            color: white; padding: 14px; border-radius: 12px; outline: none; 
        }
        .security-btn-group { margin-top: 25px; } /* Added Gaps */

        /* App Manager */
        .app-row { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.02); padding: 12px; border-radius: 12px; margin-bottom: 10px; }
        .app-info { display: flex; align-items: center; gap: 12px; }
        .app-info img { width: 32px; height: 32px; object-fit: contain; }

        /* Buttons */
        .btn { border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: #000; width: 100%; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-link { background: none; color: var(--primary); text-decoration: underline; padding: 5px; }
        .btn-red { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; width: 100%; }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <h2>Gemini OS</h2>
        <div class="nav-link active" onclick="changeP('about', this)"><i class="fas fa-id-card"></i> About</div>
        <div class="nav-link" onclick="changeP('personal', this)"><i class="fas fa-palette"></i> Wallpaper</div>
        <div class="nav-link" onclick="changeP('apps', this)"><i class="fas fa-th-large"></i> App Manager</div>
        <div class="nav-link" onclick="changeP('security', this)"><i class="fas fa-shield-alt"></i> Security</div>
        <div class="nav-link" onclick="changeP('reset', this)"><i class="fas fa-sync"></i> System Reset</div>
    </div>

    <div class="content">
        <div id="about" class="page active">
            <div class="card profile-header">
                <i class="fas fa-circle-user avatar-icon"></i>
                <h2 id="current-name" style="margin: 5px 0;">User Name</h2>
                <button class="btn btn-link" onclick="toggleNameEdit(true)">Edit Profile Name</button>
                
                <div id="inline-edit" class="inline-edit">
                    <input type="text" id="name-input" placeholder="New Name">
                    <div style="margin-top:10px; display: flex; gap:10px; justify-content:center;">
                        <button class="btn" style="background:var(--primary); padding: 8px 20px;" onclick="saveName()">Save</button>
                        <button class="btn" style="background:#334155; color:white; padding: 8px 20px;" onclick="toggleNameEdit(false)">Cancel</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="storage-label">
                    <span>Live Storage Estimate</span>
                    <span id="st-percent">0% Used</span>
                </div>
                <div class="progress-bar"><div id="st-fill" class="progress-fill" style="width: 0%"></div></div>
                <p id="st-details" style="font-size: 0.8rem; color: var(--text-dim); margin-top: 10px;"></p>
            </div>
        </div>

        <div id="personal" class="page">
            <h3>Personalization</h3>
            <div id="wp-preview" class="live-preview-box">
                <span class="preview-tag">Live Preview</span>
            </div>
            
            <div class="wp-container">
                <div class="wp-item" style="background-image: url('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=200');" onclick="applyWP('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=1200')"></div>
                <div class="wp-item" style="background-image: url('https://images.unsplash.com/photo-1477346611705-65d1883cee1e?w=200');" onclick="applyWP('https://images.unsplash.com/photo-1477346611705-65d1883cee1e?w=1200')"></div>
                <div class="wp-item" style="background-image: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=200');" onclick="applyWP('https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=1200')"></div>
                <div class="wp-item" style="background-image: url('https://images.unsplash.com/photo-1470770841072-f978cf4d019e?w=200');" onclick="applyWP('https://images.unsplash.com/photo-1470770841072-f978cf4d019e?w=1200')"></div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="document.getElementById('file-upload').click()"><i class="fas fa-upload"></i> Upload Custom Wallpaper</button>
                <input type="file" id="file-upload" hidden accept="image/*" onchange="uploadWP(this)">
            </div>
        </div>

        <div id="apps" class="page">
            <h3>Manage Applications</h3>
            <div id="apps-list">Scanning...</div>
        </div>

        <div id="security" class="page">
            <h3>Device Security</h3>
            <div class="card">
                <div class="input-wrapper">
                    <input type="password" id="p1" placeholder="New Password">
                    <i class="fas fa-eye" onclick="togglePass('p1')"></i>
                </div>
                <div class="input-wrapper">
                    <input type="password" id="p2" placeholder="Confirm Password">
                    <i class="fas fa-eye" onclick="togglePass('p2')"></i>
                </div>
                <input type="text" id="hint" placeholder="Security Hint">
                
                <div class="security-btn-group">
                    <button class="btn btn-primary" onclick="saveSec()">Save Security Settings</button>
                </div>
            </div>
        </div>

        <div id="reset" class="page">
            <div class="card" style="border-color: #ef4444; text-align: center;">
                <h3>System Recovery</h3>
                <p style="color: var(--text-dim);">Factory Reset will wipe all data including apps, passwords, and wallpapers. This action is permanent.</p>
                <button class="btn btn-red" onclick="fullWipe()">Factory Reset Now</button>
            </div>
        </div>
    </div>
</div>

<script src="../../db-manager.js"></script>
<script>
    function changeP(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
        if(id === 'about') fetchSt();
        if(id === 'apps') fetchAppList();
    }

    // Name Logic (Inline)
    function toggleNameEdit(show) {
        document.getElementById('inline-edit').style.display = show ? 'block' : 'none';
        if(show) document.getElementById('name-input').value = document.getElementById('current-name').innerText;
    }

    function saveName() {
        const n = document.getElementById('name-input').value;
        if(n.trim()) {
            localStorage.setItem('os_username', n);
            document.getElementById('current-name').innerText = n;
            toggleNameEdit(false);
            if(window.parent.updateUsername) window.parent.updateUsername(n);
        }
    }

    // Storage Logic
    function fetchSt() {
        if (navigator.storage && navigator.storage.estimate) {
            navigator.storage.estimate().then(est => {
                const percent = Math.round((est.usage / est.quota) * 100) || 1;
                document.getElementById('st-percent').innerText = percent + "% Used";
                document.getElementById('st-fill').style.width = percent + "%";
                document.getElementById('st-details').innerText = `${Math.round(est.usage/1024/1024)} MB used of ${Math.round(est.quota/1024/1024)} MB available`;
            });
        }
    }

    // Wallpaper Logic
    function applyWP(url) {
        localStorage.setItem('os_wallpaper', url);
        document.getElementById('wp-preview').style.backgroundImage = `url('${url}')`;
        if(window.parent.updateWallpaper) window.parent.updateWallpaper(url);
    }

    function uploadWP(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => applyWP(e.target.result);
            reader.readAsDataURL(input.files[0]);
        }
    }

    // App List
    async function fetchAppList() {
        const container = document.getElementById('apps-list');
        const apps = await getInstalledApps();
        container.innerHTML = apps.length ? "" : "No third-party apps found.";
        apps.forEach(app => {
            container.innerHTML += `
                <div class="app-row">
                    <div class="app-info">
                        <img src="${app.icon || '../../assets/default.png'}" onerror="this.src='../../assets/default.png'">
                        <span>${app.name}</span>
                    </div>
                    <button class="btn" style="background:#ef4444; color:white; padding:5px 12px;" onclick="delApp('${app.id}')">Uninstall</button>
                </div>`;
        });
    }

    async function delApp(id) {
        if(confirm("Uninstall app?")) {
            await uninstallApp(id);
            fetchAppList();
            if(window.parent.initOS) window.parent.initOS();
        }
    }

    // Security Logic
    function togglePass(id) {
        const input = document.getElementById(id);
        input.type = input.type === 'password' ? 'text' : 'password';
    }

function saveSec() {
    const p1 = document.getElementById('p1').value;
    const p2 = document.getElementById('p2').value;
    const hint = document.getElementById('hint').value;

    // যদি দুটি বক্সই খালি থাকে, তবে পাসওয়ার্ড রিমুভ হবে
    if (p1 === "" && p2 === "") {
        if(confirm("Do you want to remove the password and keep the system unprotected?")) {
            localStorage.removeItem('os_password');
            localStorage.removeItem('os_hint');
            alert("Security password removed successfully!");
        }
        return;
    }

    // ৪ ডিজিটের শর্ত এবং ম্যাচিং চেক
    if (p1.length < 4) {
        return alert("Password must be at least 4 characters long!");
    }
    if (p1 !== p2) {
        return alert("Passwords do not match!");
    }

    // পাসওয়ার্ড সেভ করা
    localStorage.setItem('os_password', p1);
    localStorage.setItem('os_hint', hint);
    alert("Security updated successfully!");
}

    // Factory Reset
    async function fullWipe() {
        if(confirm("Wipe all system data?")) {
            localStorage.clear();
            const dbs = await window.indexedDB.databases();
            dbs.forEach(db => window.indexedDB.deleteDatabase(db.name));
            window.parent.location.reload();
        }
    }

    window.onload = () => {
        const name = localStorage.getItem('os_username') || "User Name";
        document.getElementById('current-name').innerText = name;
        const wp = localStorage.getItem('os_wallpaper') || 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=400';
        document.getElementById('wp-preview').style.backgroundImage = `url('${wp}')`;
        fetchSt();
    };
</script>
</body>
</html>